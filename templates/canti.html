{% extends "base.html" %}

{% block title %}Beam Force Input - SFD & BMD Plotter{% endblock %}

{% block content %}
<div class="container py-5">

  <h2 class="mb-4 text-center" style="color: #6a0dad; font-weight: bold;">Beam Force Input</h2>

  <!-- Header Image -->
  <div class="text-center mb-4">
    <img src="/static/canti.png" alt="Beam Illustration" class="img-fluid rounded shadow-sm">
  </div>

  <p class="lead mb-4">
    CONSIDER LEFT END AS THE ORIGIN AND MEASURE DISTANCES TOWARDS RIGHT AS POSITIVE<br>
    DONT FORGET TO PUT -ve SIGN IF YOUR FORCE IS DOWNWARD.<br>
    ADD AS MANY FORCES AS YOU WANT, PLEASE REMOVE BLANK ROWS WITH THE REMOVE BUTTON<br>
  </p>

  <!-- Beam Length -->
  <div class="card p-4 mb-4">
    <div class="mb-3">
      <label for="lengthInput" class="form-label">Beam Length</label>
      <input type="number" class="form-control" id="lengthInput" placeholder="Enter beam length" required>
    </div>
  </div>

  <p class="lead mb-4">Enter the point forces you want to apply</p>

  <!-- Concentrated Forces Table -->
  <div class="card p-4 mb-4">
    <h4 class="mb-3">Concentrated Forces</h4>
    <table class="table table-bordered text-center" id="dataTable">
      <thead>
        <tr>
          <th>Distance</th>
          <th>Force</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <button type="button" class="btn btn-primary" onclick="addRow('dataTable')">Add POINT Force</button>
  </div>

  <p class="lead mb-4">
    Enter the distributed force eqn with respect to your starting point of force application (not from your origin!)<br>
    DONT FORGET TO PUT -ve SIGN IF YOUR FORCE IS DOWNWARD.<br>
  </p>

  <!-- Distributed Forces Table -->
  <div class="card p-4 mb-4">
    <h4 class="mb-3">Distributed Forces</h4>
    <table class="table table-bordered text-center" id="dataTable2">
      <thead>
        <tr>
          <th>Start Point</th>
          <th>End Point</th>
          <th>Force Gradient Equation</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <button type="button" class="btn btn-primary" onclick="addRow('dataTable2')">Add DISTRIBUTED Force</button>
  </div>

  <!-- Submit Button -->
  <div class="text-center">
    <button type="button" class="btn btn-success btn-lg" onclick="submitAll()">Submit</button>
  </div>

</div>

<script>
  function addRow(tableId) {
    const tableBody = document.getElementById(tableId).getElementsByTagName('tbody')[0];
    const newRow = document.createElement('tr');

    if (tableId === 'dataTable') {
      newRow.innerHTML = `
        <td><input type="number" class="form-control position-input" name="distance" placeholder="Enter distance of point force from origin"></td>
        <td><input type="number" class="form-control" name="force" placeholder="Enter the Force (-ve if downward)"></td>
        <td><button type="button" class="btn btn-danger btn-sm" onclick="removeRow(this)">Remove</button></td>
      `;
    } else if (tableId === 'dataTable2') {
      newRow.innerHTML = `
        <td><input type="number" class="form-control position-input" name="idistance" placeholder="Enter Starting point of force"></td>
        <td><input type="number" class="form-control position-input" name="fdistance" placeholder="Enter Ending point of force"></td>
        <td><input type="text" class="form-control" name="localeqn" placeholder="e.g. 2*x+5 or x**2 (-ve for downward, wrt start)"></td>
        <td><button type="button" class="btn btn-danger btn-sm" onclick="removeRow(this)">Remove</button></td>
      `;
    }

    tableBody.appendChild(newRow);
  }

  function removeRow(button) {
    const row = button.closest('tr');
    row.remove();
  }

  function submitAll() {
    const lengthInput = document.getElementById('lengthInput');
    const beamLength = parseFloat(lengthInput.value);
    if (!beamLength || beamLength <= 0) {
      alert("Please enter a valid beam length!");
      lengthInput.focus();
      return;
    }

    const checkTable = tableId => {
      const table = document.getElementById(tableId).getElementsByTagName('tbody')[0];
      for (let row of table.rows) {
        const inputs = row.getElementsByTagName('input');

        for (let input of inputs) {
          if (!input.value) {
            alert("Please fill all fields!");
            input.focus();
            return false;
          }
        }

        // Validation for positions/distances
        if (tableId === 'dataTable') {
          const pos = parseFloat(inputs[0].value);
          if (pos < 0 || pos > beamLength) {
            alert(`Point force distance must be between 0 and ${beamLength}`);
            inputs[0].focus();
            return false;
          }
        } else if (tableId === 'dataTable2') {
          const start = parseFloat(inputs[0].value);
          const end = parseFloat(inputs[1].value);
          if (start < 0 || start > beamLength) {
            alert(`Distributed force start must be between 0 and ${beamLength}`);
            inputs[0].focus();
            return false;
          }
          if (end < 0 || end > beamLength) {
            alert(`Distributed force end must be between 0 and ${beamLength}`);
            inputs[1].focus();
            return false;
          }
          if (start > end) {
            alert("Distributed force start cannot be greater than end");
            inputs[0].focus();
            return false;
          }
        }
      }
      return true;
    };

    if (!checkTable('dataTable') || !checkTable('dataTable2')) return;

    const extractTableData = tableId => {
      const table = document.getElementById(tableId).getElementsByTagName('tbody')[0];
      const rows = table.getElementsByTagName('tr');
      let tableData = [];
      for (let row of rows) {
        const inputs = row.getElementsByTagName('input');
        let rowObj = {};
        for (let input of inputs) rowObj[input.name || 'col'] = input.value;
        tableData.push(rowObj);
      }
      return tableData;
    };

    const finalData = {
      length: beamLength,
      table1: extractTableData('dataTable'),
      table2: extractTableData('dataTable2')
    };

    const form = document.createElement('form');
    form.method = 'POST';
    form.action = '/simple';
    const input = document.createElement('input');
    input.type = 'hidden';
    input.name = 'json_data';
    input.value = JSON.stringify(finalData);
    form.appendChild(input);
    document.body.appendChild(form);
    form.submit();
  }
</script>
{% endblock %}
